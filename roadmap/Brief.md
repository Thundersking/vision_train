# ТЕХНИЧЕСКОЕ ЗАДАНИЕ
## CRM система управления тренажером зрения


## 1. ОБЩАЯ ИНФОРМАЦИЯ О ПРОЕКТЕ

### 1.1 Описание бизнес-задачи

CRM система предназначена для медицинских организаций и спортивных центров, автоматизирующих процесс реабилитации пациентов через специализированные упражнения на мобильном тренажере зрения (Unity-приложение).

**Ключевые бизнес-цели:**
- Повышение качества реабилитации и удобства работы специалистов
- Централизованное хранение данных пациентов с разграничением доступа между организациями
- Ускорение диагностики и назначения программ, автоматизация статистики
- Монетизация через подписочную модель
- Интеграция с мобильным тренажером зрения для сбора данных

### 1.2 Иерархия пользователей

**Организационная структура:**
```
Клиники/Тренажерные залы (organizations)
├── Подразделения (departments)
└── Врачи/Тренеры (users)
    └── Пациенты (patients)
        └── Устройства (devices)
```

**Роли пользователей:**
- **super_admin** - управляет всеми организациями в системе
- **organization_admin** - администратор организации (полные права в рамках тенанта)
- **organization_manager** - менеджер организации (только просмотр отчетов)  
- **doctor** - врач/тренер (работа с пациентами и упражнениями)

### 1.3 Принципы системы

- **Мультитенантность:** полная изоляция данных между организациями
- **Детальная аналитика:** 6 типов графиков, временные метрики, статистика по шарикам
- **Гибкость настроек:** JSON-конфигурации для 3D упражнений
- **Безопасность:** аудит всех операций с медицинскими данными
- **Интеграция:** REST API для Unity приложения с JWT аутентификацией

---

## 2. ТЕХНОЛОГИЧЕСКИЙ СТЕК

### 2.1 Backend
- **Framework:** Laravel 11
- **База данных:** PostgreSQL (последняя стабильная версия)
- **Мультитенантность:** Laravel Organization library

### 2.2 Frontend  
- **Framework:** Livewire
- **Стилизация:** TailwindCSS для адаптивности
- **Адаптивность:** Desktop-first с поддержкой планшетов

### 2.3 Интеграция
- **Unity API:** REST endpoints для мобильного приложения
- **Файловое хранилище:** локальная файловая система сервера
- **Уведомления:** Email через Laravel Mail + in-app notifications
- **QR-коды:** генерация через PHP библиотеки

---

## 3. АРХИТЕКТУРА БАЗЫ ДАННЫХ

### 3.1 Организационные сущности

**organizations (организации/клиники)**
```sql
id, name, type (medical_center/fitness_gym/stadium), 
is_active, subscription_plan, created_at, updated_at
```

**departments (подразделения)**  
```sql
id, organization_id, name, description, 
is_active, created_at, updated_at
```

**users (пользователи системы)**
```sql
id, organization_id, department_id, name, email, 
password, role (super_admin/organization_admin/organization_manager/doctor),
license_number, phone, is_active, 
timezone, created_at, updated_at
```

### 3.2 Пациенты и устройства

**patients (пациенты)**
```sql
id, organization_id, user_id (закрепленный врач), 
name, email, phone, hand_size_cm,
birth_date, timezone, notes, 
is_active, created_at, updated_at
```

**devices (устройства)**
```sql
id, organization_id, name, device_type (office_device/personal_device),
device_identifier, is_active,
last_activity_at, created_at, updated_at
```

**patient_devices (связь многие-ко-многим)**
```sql
id, patient_id, device_id, is_primary, 
assigned_at, assigned_by, notes
```

**patient_examinations (журнал обследований)**
```sql
id, patient_id, examination_type (primary/intermediate/final),
examination_text, examination_date, examined_by, 
created_at, updated_at
```

### 3.3 Упражнения и шаблоны

**exercise_types (типы упражнений)**
```sql
id, name, dimension (2d/3d), is_customizable (boolean),
description, created_at, updated_at
```

**exercise_templates (шаблоны упражнений)**
```sql
id, organization_id, exercise_type_id, name, description,
settings (JSON - полные настройки для 3D),
instructions_text, media_links (JSON),
is_public, created_by, created_at, updated_at
```

**exercises (выполненные упражнения)**
```sql
id, patient_id, exercise_type_id, exercise_template_id,
settings_override (JSON), duration_ms, 
fatigue_right_eye, fatigue_left_eye, fatigue_head (1-5),
patient_decision (continue/stop), notes,
started_at, completed_at, created_at
```

**ball_collections (детальные данные шариков)**
```sql
id, exercise_id, ball_sequence_number, 
distance_coordinate, horizontal_coordinate, vertical_coordinate,
ball_size, accuracy_percent, 
collection_time_ms, time_from_previous_ms,
created_at
```

### 3.4 Программы реабилитации

**complex_programs (программы)**
```sql
id, organization_id, name, program_type (development/maintenance),
description, duration_days, exercises_per_day,
rest_pattern (JSON - например 5/2), 
is_active, created_by, created_at, updated_at
```

**program_exercises (упражнения в программе)**
```sql
id, complex_program_id, exercise_template_id, 
day_number, exercise_order, settings_override (JSON),
created_at, updated_at
```

**patient_programs (назначенные программы)**
```sql
id, patient_id, complex_program_id, 
status (active/completed/paused/cancelled),
current_day, total_exercises_completed,
progress_percent, assigned_by, assigned_at,
started_at, completed_at, created_at, updated_at
```

**program_status_history (история статусов)**
```sql
id, patient_program_id, status_from, status_to,
reason_type (medical/technical/administrative/organizational),
reason_comment, changed_at, changed_by
```

### 3.5 Система подключений

**connection_tokens (QR-коды подключения)**
```sql
id, patient_id, token, token_type (download/connection),
expires_at, is_used, used_at, created_by, 
created_at, updated_at
```

### 3.6 Монетизация

**subscriptions (подписки организаций)**
```sql
id, organization_id, plan_name,
price_monthly, status (active/expired/suspended),
current_users_count, current_patients_count,
started_at, expires_at, created_at, updated_at
```

**patient_payments (платежи пациентов)**
```sql
id, patient_id, patient_program_id, amount,
currency, payment_method (card), 
status (pending/paid/cancelled), payment_date,
notes, created_at, updated_at
```

### 3.7 Системные таблицы

**audit_logs (аудит действий)**
```sql
id, user_id, patient_id, action_type, 
table_name, record_id, old_values (JSON), 
new_values (JSON), created_at
```

**notifications (уведомления)**
```sql
id, user_id, type, title, message, 
is_read, read_at, created_at
```

**files (файловое хранилище)**
```sql
id, organization_id, filename, original_filename, 
file_path, file_size, mime_type,
uploaded_by, created_at
```

---

## 4. КОНФИГУРАЦИЯ 3D УПРАЖНЕНИЙ

### 4.1 JSON Schema для настроек

```json
{
    "ball_count": 10,
    "ball_size": 5,
    "target_accuracy_percent": 80,
    "vertical_area": "full",
    "horizontal_area": "full", 
    "distance_area": "full",
    "duration_ms": 60000,
    "speed": "medium"
}
```

### 4.2 Допустимые значения

**Области размещения:**
- `vertical_area`: "full", "top", "bottom"
- `horizontal_area`: "full", "left", "right"  
- `distance_area`: "full", "near", "medium", "far"

**Другие параметры:**
- `ball_count`: 1-50
- `ball_size`: 1-10
- `target_accuracy_percent`: 1-100
- `speed`: "slow", "medium", "fast"

---

## 5. ОСНОВНЫЕ СЦЕНАРИИ ИСПОЛЬЗОВАНИЯ

### 5.1 Сценарии врача
1. **Регистрация пациента**
   - Ввод ФИО, контактов, даты начала работы
   - Обязательное измерение размера руки в см
   - Привязка к врачу и подразделению

2. **Проведение обследования**
   - Внесение текстовых результатов в журнал
   - Выбор типа обследования (первичное/промежуточное/итоговое)
   - Привязка к дате обследования

3. **Подключение устройства**
   - Генерация QR-кода для скачивания приложения
   - Генерация QR-кода для подключения к врачу
   - Отправка кодов по email пациенту

4. **Создание программы**
   - Выбор типа программы (развивающая/поддерживающая)
   - Настройка длительности и частоты
   - Добавление 2D и 3D упражнений с настройками
   - Назначение пациенту

5. **Анализ результатов**
   - Просмотр таблицы выполненных упражнений
   - Детальный анализ координат и времени шариков
   - 6 графиков распределения времени и задержек
   - Отслеживание прогресса программы

### 5.2 Сценарии администратора
1. **Управление организацией**
   - Создание подразделений
   - Добавление врачей и назначение ролей
   - Контроль лимитов подписки

2. **Мониторинг системы**
   - Просмотр статистики использования
   - Аудит действий пользователей
   - Управление уведомлениями

### 5.3 API сценарии Unity
1. **Аутентификация устройства** - JWT токен по connection_token
2. **Получение упражнений** - список назначенных упражнений с настройками
3. **Отправка результатов** - данные выполненного упражнения + координаты всех шариков

---

## 6. ДЕТАЛЬНОЕ ОПИСАНИЕ ФУНКЦИОНАЛЬНЫХ МОДУЛЕЙ

### 6.1 Модуль управления организациями

#### 6.1.1 CRUD организаций (organizations)
**Роли доступа:** super_admin

**Форма создания организации:**
```
Название организации* (text, max 255)
Тип организации* (select: medical_center/fitness_gym/stadium)
Контактный email* (email)
Телефон (phone)
Адрес (textarea)
Тарифный план* (select: basic/standard/premium)
Лимит пользователей* (number, min 1, max 100)
Лимит пациентов* (number, min 10, max 1000)
Статус (checkbox: active/inactive, default: active)
```

**Валидация:**
- Уникальность email в системе
- Проверка корректности телефона
- Лимиты не могут быть меньше текущего количества пользователей/пациентов

**Функциональность:**
- Список всех организаций с поиском и фильтрацией
- Быстрые фильтры: активные/неактивные, по типу организации
- Массовые действия: активация/деактивация, смена тарифа
- Экспорт списка в CSV

#### 6.1.2 CRUD подразделений (departments)
**Роли доступа:** super_admin, organization_admin

**Форма подразделения:**
```
Название подразделения* (text, max 255)
Описание (textarea, max 1000)
Активно (checkbox, default: true)
Родительское подразделение (select, nullable)
```

**Функциональность:**
- Иерархическая структура подразделений (дерево)
- Перенос врачей между подразделениями
- Массовое назначение врачей в подразделение

#### 6.1.3 CRUD пользователей (users)
**Роли доступа:** super_admin, organization_admin

**Форма врача/администратора:**
```
ФИО* (text, max 255)
Email* (email, unique в рамках тенанта)
Телефон (phone)
Роль* (select: organization_admin/organization_manager/doctor)
Подразделение* (select из подразделений организации)
Часовой пояс* (select, default: организации)
Пароль* (password, min 8 символов)
Активен (checkbox, default: true)
```

**Бизнес-правила:**
- organization_admin может создавать только organization_manager и doctor
- Нельзя удалить последнего organization_admin в организации
- При деактивации пользователя - его пациенты переназначаются другому врачу
- Email уникален в пределах тенанта

### 6.2 Модуль работы с пациентами

#### 6.2.1 CRUD пациентов (patients)
**Роли доступа:** organization_admin, organization_manager, doctor

**Форма регистрации пациента:**
```
ФИО* (text, max 255)
Email (email)
Телефон* (phone)
Дата рождения* (date)
Размер руки в см* (number, min 5, max 30, step 0.1)
Закрепленный врач* (select из врачей подразделения)
Часовой пояс* (select)
Примечания (textarea, max 2000)
```

**Детальная страница пациента:**
- Основная информация с возможностью редактирования
- Вкладка "Журнал обследований"
- Вкладка "Подключенные устройства"
- Вкладка "Назначенные программы"
- Вкладка "История упражнений"
- Вкладка "Платежи"

**Список пациентов:**
- Поиск по ФИО, email, телефону
- Фильтры: по врачу, подразделению, статусу активности
- Сортировка по всем полям
- Пагинация по 25/50/100 записей

#### 6.2.2 Журнал обследований (patient_examinations)
**Роли доступа:** doctor (только своих пациентов), organization_admin, organization_manager (просмотр)

**Форма внесения обследования:**
```
Пациент* (readonly, если открыт со страницы пациента)
Тип обследования* (select: primary/intermediate/final)
Дата обследования* (datetime-local)
Результаты обследования* (rich-text editor, min 50 символов)
```

**Функциональность:**
- Хронологический список обследований пациента
- Возможность редактирования только в течение 24 часов
- Экспорт обследований пациента в PDF
- Уведомление врачу о необходимости промежуточного обследования (через 30 дней)

#### 6.2.3 Управление устройствами (devices, patient_devices)
**Роли доступа:** organization_admin, doctor

**Форма устройства:**
```
Название устройства* (text, max 255)
Тип устройства* (radio: office_device/personal_device)
Идентификатор устройства* (text, unique в рамках тенанта)
Статус (checkbox: active/inactive, default: active)
```

**Привязка устройства к пациенту:**
```
Устройство* (select из активных устройств)
Основное устройство (checkbox, только одно на пациента)
Дата назначения* (date, default: сегодня)
Примечания (textarea)
```

### 6.3 Модуль упражнений и шаблонов

#### 6.3.1 Типы упражнений (exercise_types)
**Роли доступа:** super_admin (системный справочник)

**Предустановленные типы:**
- "2D базовые упражнения" (dimension: 2d, is_customizable: false)
- "3D упражнения с шариками" (dimension: 3d, is_customizable: true)

#### 6.3.2 Шаблоны упражнений (exercise_templates)
**Роли доступа:** organization_admin, doctor

**Форма создания шаблона:**
```
Название шаблона* (text, max 255)
Тип упражнения* (select из доступных типов)
Описание (textarea, max 1000)
Публичный шаблон (checkbox - доступен всем врачам организации)
```

**Настройки 3D упражнения (JSON в поле settings):**
```
Количество шариков* (number, 1-50, default: 10)
Размер шарика* (select: 1-10, default: 5)  
Требуемая точность* (number, 1-100%, default: 80)
Вертикальная область* (select: full/top/bottom, default: full)
Горизонтальная область* (select: full/left/right, default: full)
Область расстояний* (select: full/near/medium/far, default: full)
Длительность упражнения* (number, 10-600 секунд, default: 60)
Скорость* (select: slow/medium/fast, default: medium)
```

**Инструкции к шаблону:**
```
Текстовые инструкции (rich-text editor)
Загрузка файлов (file upload: pdf, jpg, png, mp4, mp3)
Ссылки на видео (JSON: {"youtube": "url", "vimeo": "url"})
```

**Функциональность:**
- Библиотека шаблонов с поиском и категориями
- Копирование шаблона с изменением настроек
- Предпросмотр настроек в визуальном виде
- Экспорт/импорт шаблонов между организациями

#### 6.3.3 Назначение упражнений пациентам
**Роли доступа:** doctor

**Форма назначения:**
```
Пациент* (select из пациентов врача)
Шаблон упражнения* (select из доступных шаблонов)
Индивидуальные настройки (форма переопределения из шаблона)
Дата назначения* (date, default: сегодня)
Примечания (textarea)
```

**Календарь упражнений пациента:**
- Просмотр назначенных упражнений на неделю/месяц
- Статусы выполнения: назначено/выполнено/пропущено
- Возможность переноса упражнения на другую дату

### 6.4 Модуль программ реабилитации

#### 6.4.1 Создание программ (complex_programs)
**Роли доступа:** organization_admin, doctor

**Форма программы:**
```
Название программы* (text, max 255)
Тип программы* (select: development/maintenance)
Описание (textarea, max 2000)
Длительность в днях* (number, 1-365, default: 30)
Упражнений в день* (number, 1-10, default: 2)
Паттерн отдыха* (JSON: {"work_days": 5, "rest_days": 2})
Активна (checkbox, default: true)
```

**Добавление упражнений в программу:**
- Выбор дня программы (1-N)
- Выбор шаблона упражнения
- Порядок выполнения в дне
- Индивидуальные настройки для программы

#### 6.4.2 Назначение программ (patient_programs)
**Роли доступа:** doctor

**Форма назначения программы:**
```
Пациент* (select из пациентов врача)
Программа* (select из активных программ)
Дата начала* (date, default: завтра)
Примечания (textarea)
```

**Мониторинг прогресса:**
- Процент выполнения программы
- Текущий день программы  
- Количество выполненных/пропущенных упражнений
- Прогресс-бар с визуализацией
- График активности по дням

#### 6.4.3 Управление статусами программ (program_status_history)
**Роли доступа:** doctor, organization_admin

**Изменение статуса программы:**
```
Новый статус* (select: active/paused/cancelled/completed)
Тип причины* (select: medical/technical/administrative/organizational)
Комментарий к причине* (textarea, min 20 символов, max 500)
```

**Типизированные причины:**
- **medical**: усталость, заболевание, противопоказания, ухудшение состояния
- **technical**: проблемы с устройством, проблемы с приложением, нет интернета
- **administrative**: решение врача, смена программы, корректировка курса
- **organizational**: отпуск пациента, изменение графика, переезд

### 6.5 Модуль статистики и аналитики

#### 6.5.1 Таблица выполненных упражнений
**Роли доступа:** doctor (свои пациенты), organization_admin, organization_manager

**Отображаемые колонки:**
```
Дата и время выполнения
ФИО пациента (с ссылкой на профиль)
Тип упражнения
Длительность (мм:сс)
Иконки усталости (правый глаз/левый глаз/голова: 1-5)
Решение пациента (продолжать/остановиться)
Кнопка "Детали" (открытие модального окна)
```

**Фильтры:**
- По пациенту (мультиселект)
- По врачу (для админов)
- По дате (диапазон)
- По типу упражнения
- По уровню усталости
- По решению пациента

#### 6.5.2 Детальный анализ упражнения (ball_collections)

**Модальное окно "Детали упражнения":**

**Вкладка "Общая информация":**
- Основные данные упражнения
- Настройки упражнения
- Состояние пациента на момент выполнения

**Вкладка "Таблица шариков":**
```
№ | Координаты (D,H,V) | Размер | Точность | Время сборки | Время между
1 | (25, 15, 30)       | 5      | 85%      | 2.3с         | -
2 | (40, -10, 20)      | 5      | 92%      | 4.1с         | 1.8с
```

**Вкладка "Графики" (6 типов):**

1. **Абсолютное время по расстояниям** (10 точек)
   - X: расстояние (0-50)
   - Y: среднее время сборки (сек)

2. **Абсолютное время по горизонтальным углам** (10 точек)  
   - X: горизонтальный угол (-50 до 50)
   - Y: среднее время сборки (сек)

3. **Абсолютное время по вертикальным углам** (10 точек)
   - X: вертикальный угол (-50 до 50) 
   - Y: среднее время сборки (сек)

4. **Задержки между шариками по расстояниям** (10 точек)
   - X: расстояние между предыдущим и текущим шариком
   - Y: время между сборкой шариков (сек)

5. **Задержки по горизонтальным углам** (10 точек)
   - X: разность горизонтальных координат
   - Y: время между сборкой (сек)

6. **Задержки по вертикальным углам** (10 точек)
   - X: разность вертикальных координат  
   - Y: время между сборкой (сек)

### 6.6 Модуль QR-кодов и подключений

#### 6.6.1 Генерация QR-кодов (connection_tokens)
**Роли доступа:** doctor, organization_admin

**Модальное окно "Подключить пациента":**

**Вкладка "QR для скачивания":**
- QR-код со ссылкой на скачивание Unity приложения
- Кнопки: "Отправить по email", "Скачать PNG", "Печать"

**Вкладка "QR для подключения":**  
- QR-код с токеном подключения (срок действия 7 дней)
- Отображение статуса: активен/использован/истек
- Кнопки: "Обновить токен", "Отправить по email"

#### 6.6.2 Отправка QR-кодов по email

**Email шаблон для скачивания:**
```
Тема: Скачайте приложение для тренажера зрения
Тело: 
Здравствуйте, [ФИО пациента]!

Ваш врач [ФИО врача] из [Название организации] назначил вам программу упражнений.

Для начала работы:
1. Скачайте мобильное приложение по QR-коду (прикреплен)
2. После установки используйте второй QR-код для подключения

[QR-код скачивания]
```

**Email шаблон для подключения:**
```
Тема: Подключение к системе тренажера зрения
Тело:
Здравствуйте, [ФИО пациента]!

Используйте этот QR-код для подключения к вашему врачу в приложении.
Срок действия кода: до [дата истечения]

[QR-код подключения]

Врач: [ФИО врача]
Организация: [Название]
```

### 6.7 Модуль системы оплат

#### 6.7.1 Управление платежами (patient_payments)
**Роли доступа:** organization_admin, organization_manager, doctor (только свои пациенты)

**Форма добавления платежа:**
```
Пациент* (select)
Программа* (select из назначенных программ пациента)
Сумма* (number, min 0.01, max 99999.99)
Способ оплаты* (select: card, default: card)
Статус* (select: pending/paid/cancelled, default: pending)
Дата оплаты (date, только для статуса paid)
Примечания (textarea)
```

**Список платежей:**
- Фильтры: по пациенту, статусу, дате, программе
- Экспорт в Excel с итоговыми суммами
- Массовое изменение статуса

---

## 7. БЕЗОПАСНОСТЬ И ИНТЕГРАЦИИ

### 7.1 Система безопасности

#### 7.1.1 Аутентификация и авторизация
**Web-интерфейс:**
- Laravel Sanctum для session-based аутентификации
- Двухфакторная аутентификация (2FA) для admin ролей
- Блокировка аккаунта после 5 неудачных попыток входа на 15 минут
- Принудительная смена пароля каждые 90 дней для врачей
- Автоматический выход через 8 часов неактивности

**Unity API:**
- JWT токены с временем жизни 24 часа
- Refresh токены с временем жизни 30 дней
- Привязка токена к device_identifier устройства
- Отзыв всех токенов устройства при деактивации пациента

#### 7.1.2 Шифрование данных
**В покое (at rest):**
- Шифрование sensitive полей в БД: patient.name, patient.phone, patient.email
- Алгоритм: AES-256-GCM с ключами из Laravel config
- Отдельные ключи шифрования для каждого тенанта
- Ключи хранятся в переменных окружения (не в коде)

**В передаче (in transit):**
- HTTPS/TLS 1.3 для всех соединений
- Certificate pinning для Unity API
- Проверка целостности JSON payloads через подписи

#### 7.1.3 Контроль доступа (RBAC)
**Матрица прав доступа:**

| Сущность    | super_admin | organization_admin  | organization_manager | doctor                |
|-------------|-------------|---------------|----------------|-----------------------|
| organizations     | CRUD        | Read (свой)   | Read (свой)    | Read (свой)           |
| departments | CRUD        | CRUD          | Read           | Read                  |
| users       | CRUD        | CRU (тенанта) | Read           | Read                  |
| patients    | Read (все)  | CRUD          | Read           | CRU (своих)           |
| exercises   | Read (все)  | CRUD          | Read           | CRUD                  |
| programs    | Read (все)  | CRUD          | Read           | CRUD                  |
| payments    | Read (все)  | CRUD          | Read           | R (своих пациентов)   |
| audit_logs  | Read (все)  | Read (тенанта)| Read (тенанта) | Read (своих действий) |

**Дополнительные ограничения:**
- doctor может видеть только пациентов из своего подразделения
- organization_manager - только просмотр отчетов, без редактирования данных
- Нельзя удалить organization_admin если он последний в организации
- При деактивации врача - его пациенты переназначаются

#### 7.1.4 Аудит и логирование
**audit_logs - обязательное логирование:**
- Все операции CRUD с медицинскими данными (patients, exercises, programs)
- Изменения критичных настроек (роли, доступы, статусы)
- Все входы в систему и попытки доступа к чужим данным
- Экспорт данных и генерация отчетов

**Формат лога:**
```json
{
    "user_id": 123,
    "patient_id": 456,
    "action_type": "patient.updated",
    "table_name": "patients",
    "record_id": 456,
    "values": {"hand_size_cm": 16.2, "phone": "+7..."},
    "ip_address": "192.168.1.100",
    "user_agent": "Mozilla/5.0...",
    "created_at": "2024-01-01T12:00:00Z"
}
```

**Системы логов (Laravel Log):**
- ERROR: системные ошибки, неудачные попытки аутентификации
- WARNING: подозрительная активность, превышение лимитов API
- INFO: успешные логины, создание/изменение критичных записей
- DEBUG: детальная отладочная информация (только development)


### 7.2 Интеграции и внешние сервисы

#### 7.2.1 Email сервис
**Провайдер:** настраиваемый через Laravel Mail (SMTP/SES/Mailgun)

**Типы email уведомлений:**
- Регистрация нового пользователя (приветствие + пароль)
- Отправка QR-кодов пациентам
- Уведомления врачу о завершенных упражнениях
- Напоминания о промежуточных обследованиях
- Уведомления о превышении лимитов подписки

**Шаблоны email:**
- HTML шаблоны с адаптивным дизайном
- Подстановка переменных: {patient_name}, {doctor_name}, {clinic_name}

**Безопасность email:**
- SPF, DKIM, DMARC записи для домена
- Шифрование всех email соединений
- Защита от спама и фишинга

#### 7.2.2 Файловое хранилище
**Локальная файловая система:**
```
storage/app/organizations/{organization_id}/
├── instructions/          # Инструкции к упражнениям
│   ├── documents/        # pdf файлы
│   └── images/           # jpg, png файлы
├── exports/              # Временные файлы экспорта
└── qr_codes/            # Сгенерированные QR-коды
```

**Обработка файлов:**
- Максимальный размер файла: 10MB
- Разрешенные типы: pdf, jpg, jpeg, png
- Автоматическое изменение размера изображений > 2MB

**Права доступа к файлам:**
- Файлы недоступны напрямую через веб
- Доступ только через контроллеры с проверкой прав
- Логирование всех обращений к файлам
- Автоматическое удаление временных файлов через 24 часа

#### 7.2.3 QR-коды
**Генерация:**
- Библиотека: SimpleSoftwareIO/simple-qrcode (Laravel)
- Размер: 300x300px для печати, 150x150px для email
- Формат: PNG с прозрачным фоном
- Уровень коррекции ошибок: Medium (15%)

**Типы QR-кодов:**
1. **Download QR** - статический URL приложения
2. **Connection QR** - динамический токен с истечением

**Структура Connection QR:**
```
vision-trainer://connect?token={uuid}&clinic={organization_id}
```

**Безопасность QR:**
- Токены подключения действуют 7 дней
- Одноразовое использование токена
- Логирование всех активаций токенов


### 7.3 Система уведомлений

#### 7.3.1 In-app уведомления (notifications)
**Типы уведомлений:**
- **exercise_completed**: "Пациент {name} завершил упражнение"
- **high_fatigue_detected**: "У пациента {name} высокий уровень усталости"
- **program_status_changed**: "Программа пациента {name} изменила статус на {status}"
- **examination_reminder**: "Пора провести промежуточное обследование пациента {name}"
- **subscription_limit**: "Превышен лимит пользователей в организации"

**Отображение:**
- Колокольчик в верхнем меню с счетчиком
- Всплывающие toast-уведомления для критичных событий
- Список уведомлений с пагинацией
- Автоматическое удаление через 30 дней

#### 7.3.2 Email уведомления
**Настройки для каждого пользователя:**
```json
{
    "email_notifications": {
        "exercise_completed": true,
        "high_fatigue_detected": true,
        "program_status_changed": false,
        "examination_reminder": true,
        "daily_digest": false
    }
}
```


### 7.4 Резервное копирование

#### 7.4.1 Стратегия бэкапов
**PostgreSQL база данных:**
- Полный бэкап: ежедневно в 02:00
- Инкрементальный: каждые 4 часа
- Точка восстановления (PITR): до любой секунды за последние 30 дней
- Хранение: 7 дней локально + 90 дней в облачном хранилище

**Файлы системы:**
- Синхронизация в реальном времени (rsync)
- Версионирование файлов инструкций
- Автоматическое удаление неиспользуемых файлов через 365 дней

#### 7.4.2 План восстановления (Disaster Recovery)
**RTO (Recovery Time Objective):** 4 часа
**RPO (Recovery Point Objective):** 1 час

**Процедура восстановления:**
1. Развертывание резервного сервера (автоматизировано)
2. Восстановление БД из последнего бэкапа
3. Синхронизация файлов из облачного хранилища  
4. Переключение DNS на новый сервер
5. Проверка целостности данных и функциональности

---

## 8. НЕФУНКЦИОНАЛЬНЫЕ ТРЕБОВАНИЯ

### 8.1 Производительность

#### 8.1.1 Требования к отзывчивости
**Web-интерфейс:**
- Загрузка главной страницы: < 2 секунд
- Отклик на пользовательские действия: < 300 мс
- Загрузка списков (пациенты, упражнения): < 1 секунды для 1000 записей
- Построение графиков аналитики: < 3 секунд
- Экспорт отчетов в PDF: < 5 секунд для 100 страниц
- Генерация QR-кода: < 500 мс

**Unity API:**
- Аутентификация устройства: < 1 секунды
- Получение списка упражнений: < 500 мс
- Сохранение результатов упражнения: < 1 секунды
- Средняя задержка API: < 200 мс (95-й процентиль < 500 мс)

#### 8.1.2 Пропускная способность
**Одновременные пользователи:**
- Web-интерфейс: до 200 одновременных врачей/админов
- Unity API: до 500 одновременных устройств
- Общая нагрузка: 1000 запросов в минуту на сервер

**Масштабирование данных:**
- База данных: до 100,000 пациентов на систему
- Упражнения: до 10,000 выполненных упражнений в день
- Шарики: до 1,000,000 записей ball_collections в месяц
- Файлы: до 100 ГБ файлового хранилища на тенант

#### 8.1.3 Оптимизация производительности
**База данных (PostgreSQL):**
- Индексы на все внешние ключи и поля поиска
- Партиционирование таблицы exercises по дате (ежемесячно)
- Партиционирование ball_collections по patient_id
- Connection pooling: min 10, max 50 соединений
- Кеширование часто используемых запросов (Redis)

**Frontend (Vue 3):**
- Lazy loading для больших списков (виртуализация)
- Компонентная архитектура с переиспользованием
- Code splitting по маршрутам
- Кеширование статических ресурсов (CDN)
- Image optimization и WebP формат

**Caching стратегия:**
- Redis для сессий и временных данных
- HTTP кеширование статических ресурсов (1 год)
- Database query caching (Laravel Cache)
- Кеширование результатов аналитики (1 час)

### 8.2 Масштабируемость

#### 8.2.1 Горизонтальное масштабирование
**Архитектура:**
- Stateless приложение (возможность добавления серверов)
- Load Balancer (Nginx) с round-robin распределением
- Отдельные инстансы для web и API
- Возможность масштабирования PostgreSQL (read replicas)

**Мультитенантность:**
- Изоляция данных на уровне БД (organization_id в каждой таблице)
- Horizontal sharding по organization_id при необходимости
- Независимое масштабирование файлового хранилища

#### 8.2.2 Ограничения и квоты
**По организации (organization):**
- Максимум пользователей: согласно тарифному плану (10-100)
- Максимум пациентов: согласно тарифному плану (100-1000)
- Файловое хранилище: 1-10 ГБ на тариф

**По пользователю:**
- Максимум пациентов на врача: 200
- Выполненных упражнений в день: 500
- Одновременных сессий: 3 (веб + 2 мобильных устройства)


### 8.3 Безопасность и соответствие

#### 8.3.1 Соответствие стандартам
**Медицинские стандарты:**
- Хранение медицинских данных согласно российскому законодательству
- Шифрование персональных данных (152-ФЗ)
- Журналирование доступа к медицинским записям
- Права на удаление персональных данных (GDPR-подобные)


### 8.4 Производительность инфраструктуры

#### 8.4.1 Требования к серверу
**Минимальная конфигурация (до 50 тенантов):**
- CPU: 4 cores (Intel/AMD x64)
- RAM: 16 GB
- Disk: 500 GB SSD
- Network: 100 Mbps
- OS: Ubuntu 22.04 LTS или CentOS 8

**Рекомендуемая конфигурация (до 200 тенантов):**
- CPU: 8 cores
- RAM: 32 GB
- Disk: 1 TB NVMe SSD
- Network: 1 Gbps
- Database: отдельный сервер аналогичной конфигурации

#### 8.4.2 Мониторинг производительности
**Ключевые метрики:**
- Response time percentiles (50th, 95th, 99th)
- Throughput (requests per minute)
- Error rate (< 0.1%)
- Database connection pool utilization
- Memory usage (< 80%)
- CPU utilization (< 70% average)
- Disk I/O operations

**Алерты и пороговые значения:**
- Response time > 5 секунд: WARNING
- Error rate > 1%: CRITICAL
- CPU > 85%: WARNING
- Memory > 90%: CRITICAL
- Disk space > 80%: WARNING

### 8.5 Требования к развертыванию

#### 8.5.1 CI/CD Pipeline
**Процесс развертывания:**
1. Git push в main branch
2. Automated tests (Unit + Integration)
3. Build Docker images
4. Deploy to staging
5. Automated E2E tests на staging
6. Manual approval для production
7. Blue-green deployment в production
8. Post-deployment health checks

**Rollback процедуры:**
- Автоматический rollback при падении health checks
- Database migration rollback процедуры
- Сохранение последних 5 релизов для быстрого отката
- Zero-downtime deployment стратегии

---
